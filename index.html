<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini Vision</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* --- –û–°–ù–û–í–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò --- */
        body { 
            background-color: var(--tg-theme-bg-color, #fff); 
            color: var(--tg-theme-text-color, #000); 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            overflow: hidden; 
        }
        
        /* --- –ß–ê–¢ --- */
        #chat-container { 
            position: absolute; 
            top: 0; left: 0; right: 0; bottom: 80px; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; flex-direction: column; gap: 12px; 
            -webkit-overflow-scrolling: touch; 
        }

        .message { max-width: 85%; padding: 10px 14px; border-radius: 16px; line-height: 1.5; word-wrap: break-word; font-size: 15px; }
        .user-message { align-self: flex-end; background-color: var(--tg-theme-button-color, #3390ec); color: white; }
        .bot-message { align-self: flex-start; background-color: var(--tg-theme-secondary-bg-color, #f0f0f0); }
        .bot-message img { max-width: 100%; border-radius: 8px; margin-top: 5px; }
        .user-image-preview { max-width: 200px; border-radius: 10px; margin-bottom: 5px; display: block; }
        
        /* --- –í–í–û–î (–§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ô) --- */
        #input-area { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background-color: var(--tg-theme-bg-color, #fff); 
            padding: 10px; display: flex; align-items: flex-end; gap: 8px; 
            border-top: 1px solid var(--tg-theme-hint-color, #ccc); 
            box-sizing: border-box; z-index: 1000; 
            padding-bottom: max(10px, env(safe-area-inset-bottom)); 
        }

        input[type="text"] { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ccc; background: var(--tg-theme-secondary-bg-color, #f0f0f0); color: var(--tg-theme-text-color); outline: none; }
        
        .icon-btn { background: none; border: none; cursor: pointer; color: var(--tg-theme-hint-color, #999); padding: 10px; }
        .icon-btn:hover { color: var(--tg-theme-button-color, #3390ec); }
        #send-btn { color: var(--tg-theme-button-color, #3390ec); font-weight: bold; }
        
        #file-input { display: none; }
        
        #preview-container { 
            display: none; position: fixed; bottom: 80px; left: 10px; 
            background: rgba(0,0,0,0.8); padding: 5px; border-radius: 8px; z-index: 900;
        }
        #preview-img { max-width: 100px; max-height: 100px; border-radius: 4px; }
        #remove-img { color: white; position: absolute; top: -5px; right: -5px; background: red; border-radius: 50%; width: 20px; height: 20px; text-align: center; cursor: pointer; font-size: 12px; line-height: 20px; }
    </style>
</head>
<body>

    <div id="chat-container">
        <div class="message bot-message">–ü—Ä–∏–≤–µ—Ç! –Ø —Å–Ω–æ–≤–∞ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ. –ü—Ä–∏—Å—ã–ª–∞–π —Ç–µ–∫—Å—Ç –∏–ª–∏ —Ñ–æ—Ç–æ! üì∑</div>
    </div>

    <div id="preview-container">
        <span id="remove-img">‚úñ</span>
        <img id="preview-img" src="">
    </div>

    <div id="input-area">
        <input type="file" id="file-input" accept="image/*">
        
        <button id="attach-btn" class="icon-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
        </button>

        <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
        
        <button id="send-btn" class="icon-btn">‚û§</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const fileInput = document.getElementById('file-input');
        const previewContainer = document.getElementById('preview-container');
        const previewImg = document.getElementById('preview-img');
        
        let currentBase64Image = null;

        // –§–æ—Ç–æ –ª–æ–≥–∏–∫–∞
        document.getElementById('attach-btn').addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentBase64Image = e.target.result.split(',')[1];
                    previewImg.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('remove-img').addEventListener('click', () => {
            currentBase64Image = null;
            fileInput.value = '';
            previewContainer.style.display = 'none';
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text && !currentBase64Image) return;

            const div = document.createElement('div');
            div.classList.add('message', 'user-message');
            
            if (currentBase64Image) {
                const img = document.createElement('img');
                img.src = previewImg.src;
                img.classList.add('user-image-preview');
                div.appendChild(img);
            }
            if (text) {
                const span = document.createElement('div');
                span.textContent = text;
                div.appendChild(span);
            }
            chatContainer.appendChild(div);
            setTimeout(() => chatContainer.scrollTop = chatContainer.scrollHeight, 100);

            // –û—á–∏—Å—Ç–∫–∞
            const imageToSend = currentBase64Image;
            messageInput.value = '';
            currentBase64Image = null;
            previewContainer.style.display = 'none';
            fileInput.value = '';

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message bot-message';
            loadingDiv.innerText = '–î—É–º–∞—é...';
            loadingDiv.id = 'loading';
            chatContainer.appendChild(loadingDiv);

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: text,
                        image: imageToSend 
                    })
                });
                const data = await response.json();
                document.getElementById('loading').remove();
                
                const botDiv = document.createElement('div');
                botDiv.className = 'message bot-message';
                botDiv.innerHTML = marked.parse(data.reply || "–û—à–∏–±–∫–∞");
                chatContainer.appendChild(botDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;

            } catch (e) {
                document.getElementById('loading').innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
            }
        }

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') sendMessage(); 
        });
    </script>
</body>
</html>
