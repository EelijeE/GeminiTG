<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini Pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        body { background-color: var(--tg-theme-bg-color, #fff); color: var(--tg-theme-text-color, #000); font-family: sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ */
        #header {
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-bottom: 1px solid var(--tg-theme-hint-color, #ccc);
            font-weight: bold;
            font-size: 14px;
        }
        #clear-btn {
            background: none; border: none; cursor: pointer; font-size: 16px; opacity: 0.7;
        }
        
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .message { max-width: 85%; padding: 10px 14px; border-radius: 16px; line-height: 1.5; word-wrap: break-word; font-size: 15px; }
        .user-message { align-self: flex-end; background-color: var(--tg-theme-button-color, #3390ec); color: white; }
        .bot-message { align-self: flex-start; background-color: var(--tg-theme-secondary-bg-color, #f0f0f0); }
        .bot-message img { max-width: 100%; border-radius: 8px; margin-top: 5px; }
        .user-image-preview { max-width: 200px; border-radius: 10px; margin-bottom: 5px; display: block; }
        
        #input-area { background-color: var(--tg-theme-bg-color, #fff); padding: 10px; display: flex; align-items: flex-end; gap: 10px; border-top: 1px solid var(--tg-theme-hint-color, #ccc); }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ccc; background: var(--tg-theme-secondary-bg-color, #f0f0f0); color: var(--tg-theme-text-color); outline: none; }
        
        .icon-btn { background: none; border: none; cursor: pointer; color: var(--tg-theme-hint-color, #999); padding: 10px; }
        .icon-btn:hover { color: var(--tg-theme-button-color, #3390ec); }
        #send-btn { color: var(--tg-theme-button-color, #3390ec); font-weight: bold; }
        #file-input { display: none; }
        
        #preview-container { display: none; position: absolute; bottom: 70px; left: 10px; background: rgba(0,0,0,0.8); padding: 5px; border-radius: 8px; }
        #preview-img { max-width: 100px; max-height: 100px; border-radius: 4px; }
        #remove-img { color: white; position: absolute; top: -5px; right: -5px; background: red; border-radius: 50%; width: 20px; height: 20px; text-align: center; cursor: pointer; font-size: 12px; line-height: 20px; }
    </style>
</head>
<body>

    <div id="header">
        <span>Gemini AI</span>
        <button id="clear-btn" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">üóëÔ∏è</button>
    </div>

    <div id="chat-container">
        <div class="message bot-message">–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–Ω—é –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞—à–µ–π –±–µ—Å–µ–¥—ã. –û —á–µ–º –ø–æ–≥–æ–≤–æ—Ä–∏–º?</div>
    </div>

    <div id="preview-container">
        <span id="remove-img">‚úñ</span>
        <img id="preview-img" src="">
    </div>

    <div id="input-area">
        <input type="file" id="file-input" accept="image/*">
        <button id="attach-btn" class="icon-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
        </button>
        <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
        <button id="send-btn" class="icon-btn">‚û§</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const fileInput = document.getElementById('file-input');
        const previewContainer = document.getElementById('preview-container');
        const previewImg = document.getElementById('preview-img');
        
        let currentBase64Image = null;
        let chatHistory = []; // –ó–¥–µ—Å—å —Ö—Ä–∞–Ω–∏–º –ø–∞–º—è—Ç—å

        // === –§–£–ù–ö–¶–ò–ò –ü–ê–ú–Ø–¢–ò ===
        
        function clearChat() {
            chatHistory = []; // –û–±–Ω—É–ª—è–µ–º –ø–∞–º—è—Ç—å
            chatContainer.innerHTML = '<div class="message bot-message">–ß–∞—Ç –æ—á–∏—â–µ–Ω. –Ø –∑–∞–±—ã–ª –≤—Å—ë, —á—Ç–æ –±—ã–ª–æ —Ä–∞–Ω—å—à–µ. –ù–∞—á–Ω–µ–º –∑–∞–Ω–æ–≤–æ!</div>';
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        }

        document.getElementById('clear-btn').addEventListener('click', () => {
            if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏?')) clearChat();
        });

        // === –û–ë–´–ß–ù–´–ï –§–£–ù–ö–¶–ò–ò ===

        document.getElementById('attach-btn').addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentBase64Image = e.target.result.split(',')[1];
                    previewImg.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('remove-img').addEventListener('click', () => {
            currentBase64Image = null;
            fileInput.value = '';
            previewContainer.style.display = 'none';
        });

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text && !currentBase64Image) return;

            // 1. –†–∏—Å—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const div = document.createElement('div');
            div.classList.add('message', 'user-message');
            if (currentBase64Image) {
                const img = document.createElement('img');
                img.src = previewImg.src;
                img.classList.add('user-image-preview');
                div.appendChild(img);
            }
            if (text) {
                const span = document.createElement('div');
                span.textContent = text;
                div.appendChild(span);
            }
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // 2. –û—á–∏—â–∞–µ–º –∏–Ω–ø—É—Ç—ã
            const imageToSend = currentBase64Image;
            const textToSend = text;
            
            messageInput.value = '';
            currentBase64Image = null;
            previewContainer.style.display = 'none';
            fileInput.value = '';

            // 3. –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message bot-message';
            loadingDiv.innerText = '...';
            loadingDiv.id = 'loading';
            chatContainer.appendChild(loadingDiv);

            try {
                // –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ò–°–¢–û–†–ò–Æ –í–ú–ï–°–¢–ï –° –°–û–û–ë–©–ï–ù–ò–ï–ú
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: textToSend,
                        image: imageToSend,
                        history: chatHistory // <-- –í–æ—Ç –Ω–∞—à–∞ –ø–∞–º—è—Ç—å
                    })
                });
                const data = await response.json();
                document.getElementById('loading').remove();
                
                // 4. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç –±–æ—Ç–∞
                const botDiv = document.createElement('div');
                botDiv.className = 'message bot-message';
                botDiv.innerHTML = marked.parse(data.reply || "–û—à–∏–±–∫–∞");
                chatContainer.appendChild(botDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;

                // 5. –°–û–•–†–ê–ù–Ø–ï–ú –í –ò–°–¢–û–†–ò–Æ (—Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã —ç–∫–æ–Ω–æ–º–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫)
                if (textToSend) chatHistory.push({ role: "user", text: textToSend });
                if (data.reply) chatHistory.push({ role: "model", text: data.reply });

            } catch (e) {
                document.getElementById('loading').innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
            }
        }

        document.getElementById('send-btn').addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
    </script>
</body>
</html>
