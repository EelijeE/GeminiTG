<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gemini Audio</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* --- –û–°–ù–û–í–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò --- */
        body { 
            background-color: var(--tg-theme-bg-color, #fff); 
            color: var(--tg-theme-text-color, #000); 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            margin: 0; 
            padding: 0; 
            height: 100vh; 
            overflow: hidden; /* –ó–∞–ø—Ä–µ—â–∞–µ–º —Å–∫—Ä–æ–ª–ª —Å–∞–º–æ–≥–æ —Ç–µ–ª–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
        }
        
        /* --- –ß–ê–¢ (–ö–û–ù–¢–ï–ô–ù–ï–†) --- */
        #chat-container { 
            position: absolute; /* –§–∏–∫—Å–∏—Ä—É–µ–º —á–∞—Ç */
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 80px; /* –û—Å—Ç–∞–≤–ª—è–µ–º –º–µ—Å—Ç–æ —Å–Ω–∏–∑—É –¥–ª—è –ø–∞–Ω–µ–ª–∏ –≤–≤–æ–¥–∞! */
            overflow-y: auto; /* –°–∫—Ä–æ–ª–ª–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–∞—Ç */
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px; 
            -webkit-overflow-scrolling: touch; /* –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª –Ω–∞ iOS */
        }

        .message { max-width: 85%; padding: 10px 14px; border-radius: 16px; line-height: 1.5; word-wrap: break-word; font-size: 15px; }
        .user-message { align-self: flex-end; background-color: var(--tg-theme-button-color, #3390ec); color: white; }
        .bot-message { align-self: flex-start; background-color: var(--tg-theme-secondary-bg-color, #f0f0f0); }
        .bot-message img { max-width: 100%; border-radius: 8px; margin-top: 5px; }
        .user-image-preview { max-width: 200px; border-radius: 10px; margin-bottom: 5px; display: block; }
        
        /* --- –ó–û–ù–ê –í–í–û–î–ê (–§–ò–ö–°–ò–†–û–í–ê–ù–ù–ê–Ø) --- */
        #input-area { 
            position: fixed; /* –ì–≤–æ–∑–¥—è–º–∏ –∫ –Ω–∏–∑—É —ç–∫—Ä–∞–Ω–∞ */
            bottom: 0; 
            left: 0; 
            width: 100%; 
            height: auto;
            min-height: 60px;
            background-color: var(--tg-theme-bg-color, #fff); 
            padding: 10px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            border-top: 1px solid var(--tg-theme-hint-color, #ccc); 
            box-sizing: border-box; /* –ß—Ç–æ–±—ã padding –Ω–µ –ª–æ–º–∞–ª —à–∏—Ä–∏–Ω—É */
            z-index: 1000; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
            padding-bottom: max(10px, env(safe-area-inset-bottom)); /* –£—á–µ—Ç —á–µ–ª–∫–∏ iPhone */
        }

        input[type="text"] { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ccc; background: var(--tg-theme-secondary-bg-color, #f0f0f0); color: var(--tg-theme-text-color); outline: none; }
        
        /* –ö–ù–û–ü–ö–ò */
        .icon-btn { background: none; border: none; cursor: pointer; color: var(--tg-theme-hint-color, #999); padding: 8px; display: flex; align-items: center; justify-content: center; }
        .icon-btn:hover { color: var(--tg-theme-button-color, #3390ec); }
        #send-btn { color: var(--tg-theme-button-color, #3390ec); font-weight: bold; }
        
        /* –ú–ò–ö–†–û–§–û–ù –ê–ù–ò–ú–ê–¶–ò–Ø */
        #mic-btn.recording { color: red; animation: pulse 1.5s infinite; display: none; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        #file-input { display: none; }
        
        /* –ü–†–ï–í–¨–Æ –ö–ê–†–¢–ò–ù–ö–ò (–¢–û–ñ–ï –§–ò–ö–°–ò–†–û–í–ê–ù–ù–û–ï) */
        #preview-container { 
            display: none; 
            position: fixed; /* –ü–æ–∑–∏—Ü–∏—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–∞ */
            bottom: 80px; /* –ù–∞–¥ –ø–∞–Ω–µ–ª—å—é –≤–≤–æ–¥–∞ */
            left: 10px; 
            background: rgba(0,0,0,0.8); 
            padding: 5px; 
            border-radius: 8px; 
            z-index: 900;
        }
        #preview-img { max-width: 100px; max-height: 100px; border-radius: 4px; }
        #remove-img { color: white; position: absolute; top: -5px; right: -5px; background: red; border-radius: 50%; width: 20px; height: 20px; text-align: center; cursor: pointer; font-size: 12px; line-height: 20px; }
    </style>
</head>
<body>

    <div id="chat-container">
        <div class="message bot-message">–ü—Ä–∏–≤–µ—Ç! –Ø –≤–∏–∂—É —Ñ–æ—Ç–æ –∏ —Å–ª—ã—à—É –≥–æ–ª–æ—Å. –ù–∞–∂–º–∏ –Ω–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω, —á—Ç–æ–±—ã —Å–∫–∞–∑–∞—Ç—å –º–Ω–µ —á—Ç–æ-—Ç–æ! üé§</div>
    </div>

    <div id="preview-container">
        <span id="remove-img">‚úñ</span>
        <img id="preview-img" src="">
    </div>

    <div id="input-area">
        <input type="file" id="file-input" accept="image/*">
        
        <button id="attach-btn" class="icon-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
        </button>

        <input type="text" id="message-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
        
        <button id="mic-btn" class="icon-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
        </button>

        <button id="send-btn" class="icon-btn">‚û§</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp; tg.expand();
        const chatContainer = document.getElementById('chat-container');
        const messageInput = document.getElementById('message-input');
        const fileInput = document.getElementById('file-input');
        const previewContainer = document.getElementById('preview-container');
        const previewImg = document.getElementById('preview-img');
        const micBtn = document.getElementById('mic-btn');
        
        let currentBase64Image = null;
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        // --- –õ–û–ì–ò–ö–ê –ú–ò–ö–†–û–§–û–ù–ê ---
        micBtn.addEventListener('click', async () => {
            if (!isRecording) {
                try {
                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–æ—Å—Ç—É–ø
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = () => {
                            const base64Audio = reader.result.split(',')[1];
                            sendData(null, base64Audio); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
                        };
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    micBtn.classList.add('recording');
                    messageInput.placeholder = "–ì–æ–≤–æ—Ä–∏—Ç–µ...";
                    if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');

                } catch (err) {
                    alert("–ù—É–∂–µ–Ω –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞.");
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                micBtn.classList.remove('recording');
                messageInput.placeholder = "–°–æ–æ–±—â–µ–Ω–∏–µ...";
                if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            }
        });

        // --- –õ–û–ì–ò–ö–ê –§–û–¢–û ---
        document.getElementById('attach-btn').addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentBase64Image = e.target.result.split(',')[1];
                    previewImg.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('remove-img').addEventListener('click', () => {
            currentBase64Image = null;
            fileInput.value = '';
            previewContainer.style.display = 'none';
        });

        // --- –û–¢–ü–†–ê–í–ö–ê ---
        async function sendData(text, audioBase64 = null) {
            const div = document.createElement('div');
            div.classList.add('message', 'user-message');
            
            if (audioBase64) div.textContent = "üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ";
            else if (text) div.textContent = text;
            else if (currentBase64Image) div.textContent = "üì∑ –§–æ—Ç–æ";
            else return;

            if (currentBase64Image && !audioBase64) {
                const img = document.createElement('img');
                img.src = previewImg.src;
                img.classList.add('user-image-preview');
                div.appendChild(img);
            }

            chatContainer.appendChild(div);
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            setTimeout(() => chatContainer.scrollTop = chatContainer.scrollHeight, 100);

            messageInput.value = '';
            const imageToSend = currentBase64Image;
            
            if (!audioBase64) {
                currentBase64Image = null;
                previewContainer.style.display = 'none';
                fileInput.value = '';
            }

            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message bot-message';
            loadingDiv.innerText = '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é...';
            loadingDiv.id = 'loading';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: text,
                        image: imageToSend,
                        audio: audioBase64
                    })
                });
                const data = await response.json();
                document.getElementById('loading').remove();
                
                const botDiv = document.createElement('div');
                botDiv.className = 'message bot-message';
                botDiv.innerHTML = marked.parse(data.reply || "–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç");
                chatContainer.appendChild(botDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;

            } catch (e) {
                document.getElementById('loading').innerText = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏";
            }
        }

        document.getElementById('send-btn').addEventListener('click', () => {
            const text = messageInput.value.trim();
            if (text || currentBase64Image) sendData(text);
        });
        
        messageInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter') {
                const text = messageInput.value.trim();
                if (text || currentBase64Image) sendData(text);
            }
        });
    </script>
</body>
</html>
